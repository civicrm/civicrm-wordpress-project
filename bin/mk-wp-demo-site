#!/bin/bash
set -e

## Setup a WordPress site with CiviCRM configured for demostration.
## If a site already exists, destroy and recreate it.
## Usage: mk-wp-demo-site <domain.name> <db_name> </path/to/wordpress>

## SOURCE:
## https://github.com/civicrm/civicrm-core/blob/master/tools/scripts/mk-wp-demo-site

## Pre-requisites:
## - MySQL admin credentials in ~/.my.cnf
## - Apache vhost with mod_rewrite, etc
## - DNS or /etc/hosts entries for "url"
## - WordPress+CiviCRM source tree (with CiviCRM in the right spot)
## - makepasswd
## - wp-cli
## - (strongly recommended) filesystem with "acl" support

###############################################################################
## Bootstrap

## Determine the absolute path of the directory with the file
## usage: absdirname <file-path>
function absdirname() {
  pushd $(dirname $0) >> /dev/null
    pwd
  popd >> /dev/null
}

BINDIR=$(absdirname "$0")
PRJDIR=$(dirname "$BINDIR")
WEBDIR="$PRJDIR/web"
TMPDIR="$PRJDIR/app/tmp"
source "$PRJDIR/src/civilib.sh"

###############################################################################
function usage() {
  cat <<EOT
Usage: mk-wp-demo-site SITE_URL DB_NAME
Re/creates a WP-based CiviCRM site.

  * SITE_URL: URL of the site. Example: http://example.org:8080
  * DB_NAME: MySQL database name. Example: civicrm_test

EOT

  exit 99;
}

###############################################################################
## Parse arguments and set default environment variables

[ -z "$1" ] && usage
[ "$1" = "--help" ] && usage

SITE_TITLE="CiviCRM-WordPress Demo"
SITE_URL="$1"
[ -z "$SITE_URL" ] && usage

DB_NAME="$2"
[ -z "$DB_NAME" ] && usage
DB_USER="$DB_NAME"
DB_PASS=$(cvutil_makepasswd 12)
DB_HOST=localhost

WEB_ROOT="$WEBDIR"
[ ! -d "$WEB_ROOT" ] && echo "ERROR: $WEB_ROOT: Web root directory not found." && usage
CIVI_ROOT="$WEB_ROOT/wp-content/plugins/civicrm/civicrm"
CIVI_SETTINGS="$WEB_ROOT/wp-content/plugins/civicrm/civicrm.settings.php"
CIVI_FILES="${WEB_ROOT}/wp-content/plugins/files/civicrm"
CIVI_TEMPLATEC="${CIVI_FILES}/templates_c"
CIVI_UF="WordPress"
FACL_USERS="www-data $(whoami)"

WPCLI="$WEB_ROOT/../bin/wp"
MYSQLCLI="mysql"

SITE_KEY=$(cvutil_makepasswd 16)
ADMIN_USER="admin"
ADMIN_PASS=$(cvutil_makepasswd 12)
ADMIN_EMAIL="admin@example.com"
DEMO_USER="demo"
DEMO_PASS="demo"
DEMO_EMAIL="demo@example.com"

###############################################################################
## Main
set -ex

## Drop/create MySQL DB & user
mysql_dropcreate

## (Re)create CiviCRM config files, tables, and data dirs
civicrm_install

## (Re)Create WP config files, tables, and data dirs
wp_install

## Apply demo site customizations
pushd "$WEB_ROOT" >> /dev/null
  ## Clear out default content. Load real content.
  $WPCLI post delete 1
  $WPCLI post delete 2
  $WPCLI rewrite structure '/%postname%/'
  $WPCLI rewrite flush --hard
  $WPCLI plugin install wordpress-importer --activate
  $WPCLI import ../app/config/civicrm-wordpress.xml --authors=create
  $WPCLI search-replace 'http://civicrm-wordpress.ex' "$SITE_URL"
  $WPCLI eval '$home = get_page_by_title("Welcome to CiviCRM with WordPress"); update_option("page_on_front", $home->ID); update_option("show_on_front", "page");'

  $WPCLI plugin activate civicrm

  $WPCLI role create civicrm_admin 'CiviCRM Administrator'
  $WPCLI cap add civicrm_admin \
    read \
    level_0
  $WPCLI cap add civicrm_admin \
    access_ajax_api \
    access_all_cases_and_activities \
    access_all_custom_data \
    access_civicontribute \
    access_civicrm \
    access_civievent \
    access_civigrant \
    access_civimail \
    access_civimail_subscribe_unsubscribe_pages \
    access_civimember \
    access_civipledge \
    access_civireport \
    access_contact_dashboard \
    access_contact_reference_fields \
    access_deleted_contacts \
    access_my_cases_and_activities \
    access_report_criteria \
    access_uploaded_files \
    add_cases \
    add_contacts \
    administer_civicampaign \
    administer_civicase \
    administer_civicrm \
    administer_dedupe_rules \
    administer_reports \
    administer_reserved_groups \
    administer_reserved_reports \
    administer_reserved_tags \
    administer_tagsets \
    create_manual_batch \
    delete_activities \
    delete_all_manual_batches \
    delete_contacts \
    delete_in_civicase \
    delete_in_civicontribute \
    delete_in_civievent \
    delete_in_civigrant \
    delete_in_civimail \
    delete_in_civimember \
    delete_in_civipledge \
    delete_own_manual_batches \
    edit_all_contacts \
    edit_all_events \
    edit_all_manual_batches \
    edit_contributions \
    edit_event_participants \
    edit_grants \
    edit_groups \
    edit_memberships \
    edit_own_manual_batches \
    edit_pledges \
    export_all_manual_batches \
    export_own_manual_batches \
    gotv_campaign_contacts \
    import_contacts \
    interview_campaign_contacts \
    make_online_contributions \
    manage_campaign \
    merge_duplicate_contacts \
    profile_create \
    profile_edit \
    profile_listings \
    profile_listings_and_forms \
    profile_view \
    register_for_events \
    release_campaign_contacts \
    reserve_campaign_contacts \
    sign_civicrm_petition \
    translate_civicrm \
    view_all_activities \
    view_all_contacts \
    view_all_manual_batches \
    view_all_notes \
    view_debug_output \
    view_event_info \
    view_event_participants \
    view_own_manual_batches \
    view_public_civimail_content

  $WPCLI user create "$DEMO_USER" "$DEMO_EMAIL" --role=civicrm_admin --user_pass="$DEMO_PASS"
popd >> /dev/null

## Display summary
set +x
cvutil_summary "New Site Summary"  SITE_URL DB_NAME WEB_ROOT CIVI_ROOT ADMIN_USER ADMIN_PASS DEMO_USER DEMO_PASS
